-- PS99 ENHANCED STATS HUD (WITH EGGS & QUEST)

repeat task.wait() until game:IsLoaded()

-- SERVICES
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

-- remove old gui
pcall(function()
    CoreGui:FindFirstChild("StatsOverlay"):Destroy()
end)

-- ================= GAME MODULES =================
local function safeRequire(module)
    local success, result = pcall(require, module)
    return success and result or nil
end

local Library = ReplicatedStorage:FindFirstChild("Library")
local Client = Library and safeRequire(Library.Client)
local Save = Client and Client.Save
local QuestCmds = Client and Client.QuestCmds

local function getPlayerSave()
    if not Save then return {} end
    local success, saves = pcall(Save.GetSaves)
    if not success or not saves then return {} end
    return saves[player] or {}
end

local function getQuests()
    local save = getPlayerSave()
    return save.Goals or {}
end

-- ================= GUI =================
local gui = Instance.new("ScreenGui")
gui.Name = "StatsOverlay"
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.Parent = CoreGui

-- background
local bg = Instance.new("Frame")
bg.AnchorPoint = Vector2.new(0.5,0.5)
bg.Position = UDim2.fromScale(0.5,0.5)
bg.Size = UDim2.fromScale(2,2)
bg.BackgroundColor3 = Color3.new(0,0,0)
bg.BorderSizePixel = 0
bg.Parent = gui

-- container (increased height for more stats)
local container = Instance.new("Frame")
container.AnchorPoint = Vector2.new(0.5,0.5)
container.Position = UDim2.fromScale(0.5,0.5)
container.Size = UDim2.fromOffset(600,450)
container.BackgroundTransparency = 1
container.Parent = bg

-- label helper
local function makeLabel(y, size, align)
    local t = Instance.new("TextLabel")
    t.Position = UDim2.fromOffset(0,y)
    t.Size = UDim2.new(1,0,0,size)
    t.BackgroundTransparency = 1
    t.Font = Enum.Font.GothamBold
    t.TextSize = size - 4
    t.TextColor3 = Color3.new(1,1,1)
    t.TextXAlignment = align or Enum.TextXAlignment.Center
    t.TextYAlignment = Enum.TextYAlignment.Center
    t.TextWrapped = true
    t.Parent = container
    return t
end

-- labels
local title = makeLabel(0,40)
title.Text = "STATS OVERLAY"
title.TextSize = 32

local playerLbl   = makeLabel(60,26)
local diamondsLbl = makeLabel(100,26)
local rateLbl     = makeLabel(130,22)
local eggsLbl     = makeLabel(170,26)
local questLbl    = makeLabel(210,22, Enum.TextXAlignment.Center)
local questProgress = makeLabel(238,20, Enum.TextXAlignment.Center)
local timeLbl     = makeLabel(280,28)

-- quest details label (smaller, wraps)
questLbl.TextSize = 18
questProgress.TextSize = 16
questProgress.TextColor3 = Color3.fromRGB(255, 215, 0)

-- ================= BUTTONS =================
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.fromOffset(150,40)
closeBtn.Position = UDim2.fromScale(0.5,1)
closeBtn.AnchorPoint = Vector2.new(0.5,1)
closeBtn.Text = "CLOSE"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 18
closeBtn.BackgroundColor3 = Color3.fromRGB(220,20,60)
closeBtn.TextColor3 = Color3.new(1,1,1)
closeBtn.Parent = container
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0,8)

local openBtn = Instance.new("TextButton")
openBtn.Size = UDim2.fromOffset(150,40)
openBtn.Position = UDim2.fromScale(0.5,0.9)
openBtn.AnchorPoint = Vector2.new(0.5,0.5)
openBtn.Text = "OPEN STATS"
openBtn.Font = Enum.Font.GothamBold
openBtn.TextSize = 18
openBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
openBtn.TextColor3 = Color3.new(1,1,1)
openBtn.Parent = gui
Instance.new("UICorner", openBtn).CornerRadius = UDim.new(0,8)

-- ================= VISIBILITY =================
local visible = true
local startTime = os.clock()

local function setVisible(v)
    visible = v
    bg.Visible = v
    openBtn.Visible = not v
end

closeBtn.MouseButton1Click:Connect(function()
    setVisible(false)
end)

openBtn.MouseButton1Click:Connect(function()
    setVisible(true)
end)

-- ================= HELPERS =================
local function fmt(n)
    if n >= 1e9 then return string.format("%.2fB", n/1e9)
    elseif n >= 1e6 then return string.format("%.2fM", n/1e6)
    elseif n >= 1e3 then return string.format("%.2fK", n/1e3)
    end
    return tostring(math.floor(n))
end

local function fmtTime(t)
    return string.format(
        "%02d:%02d:%02d",
        math.floor(t/3600),
        math.floor(t%3600/60),
        math.floor(t%60)
    )
end

-- ================= DIAMONDS =================
local diamondsStat
task.spawn(function()
    local ls = player:WaitForChild("leaderstats", 10)
    if ls then
        diamondsStat =
            ls:FindFirstChild("ğŸ’ Diamonds")
            or ls:FindFirstChild("\240\159\146\142 Diamonds")
            or ls:FindFirstChild("Diamonds")
    end
end)

local lastDiamonds = 0
local lastCheck = os.clock()
local diamondRate = 0

-- ================= EGG TRACKING =================
local eggsHatched = 0
local initialEggCount = nil

-- Track eggs from save data
task.spawn(function()
    task.wait(2) -- Wait for game to load
    
    local save = getPlayerSave()
    if save.EggsHatched then
        initialEggCount = save.EggsHatched
        eggsHatched = initialEggCount
    end
end)

-- ================= QUEST TRACKING =================
local currentQuestText = "No active quest"
local currentQuestProgress = ""

local function updateQuestDisplay()
    local quests = getQuests()
    
    if not quests or not next(quests) then
        currentQuestText = "ğŸ“‹ Quest: No active quests"
        currentQuestProgress = ""
        return
    end
    
    -- Find the first incomplete quest
    local activeQuest = nil
    for _, quest in pairs(quests) do
        if quest.Progress and quest.Amount then
            if quest.Progress < quest.Amount then
                activeQuest = quest
                break
            end
        end
    end
    
    if activeQuest then
        -- Get quest title
        local title = "Unknown Quest"
        if QuestCmds and QuestCmds.MakeTitle then
            local success, result = pcall(function()
                return QuestCmds.MakeTitle(activeQuest)
            end)
            if success and result then
                title = result
            end
        elseif activeQuest.Type then
            title = "Quest Type: " .. tostring(activeQuest.Type)
        end
        
        -- Shorten title if too long
        if #title > 50 then
            title = title:sub(1, 47) .. "..."
        end
        
        local progress = activeQuest.Progress or 0
        local amount = activeQuest.Amount or 1
        local percentage = math.floor((progress / amount) * 100)
        
        currentQuestText = "ğŸ“‹ Quest: " .. title
        currentQuestProgress = string.format("Progress: %s / %s (%d%%)", 
            fmt(progress), fmt(amount), percentage)
    else
        currentQuestText = "ğŸ“‹ Quest: All quests completed!"
        currentQuestProgress = "âœ…"
    end
end

-- ================= UPDATE LOOP =================
local updateCounter = 0

RunService.RenderStepped:Connect(function()
    if not visible then return end
    
    updateCounter = updateCounter + 1

    -- Basic stats (update every frame)
    playerLbl.Text = "PLAYER: " .. player.Name
    timeLbl.Text = "â± Time: " .. fmtTime(os.clock() - startTime)

    -- Diamonds
    if diamondsStat then
        local d = diamondsStat.Value
        diamondsLbl.Text = "ğŸ’ Diamonds: " .. fmt(d)

        if os.clock() - lastCheck >= 5 then
            diamondRate = (d - lastDiamonds) / ((os.clock() - lastCheck) / 60)
            lastDiamonds = d
            lastCheck = os.clock()
        end

        rateLbl.Text = "ğŸ’ Rate: +" .. fmt(math.max(diamondRate, 0)) .. " / min"
    else
        diamondsLbl.Text = "ğŸ’ Diamonds: Loading..."
        rateLbl.Text = "ğŸ’ Rate: --"
    end
    
    -- Eggs hatched (update from save every 60 frames / ~1 second)
    if updateCounter % 60 == 0 then
        local save = getPlayerSave()
        if save.EggsHatched then
            if initialEggCount == nil then
                initialEggCount = save.EggsHatched
            end
            eggsHatched = save.EggsHatched
        end
    end
    
    if initialEggCount then
        local sessionEggs = eggsHatched - initialEggCount
        eggsLbl.Text = string.format("ğŸ¥š Eggs: %s (Session: +%s)", 
            fmt(eggsHatched), fmt(math.max(sessionEggs, 0)))
    else
        eggsLbl.Text = "ğŸ¥š Eggs: Loading..."
    end
    
    -- Quest (update every 120 frames / ~2 seconds)
    if updateCounter % 120 == 0 then
        updateQuestDisplay()
    end
    
    questLbl.Text = currentQuestText
    questProgress.Text = currentQuestProgress
end)

-- ================= GLOBAL CONTROLS =================
getgenv().statsHUD = {
    close = function()
        setVisible(false)
    end,
    open = function()
        setVisible(true)
    end,
    toggle = function()
        setVisible(not visible)
    end,
    resetTimer = function()
        startTime = os.clock()
        print("âœ… Timer reset!")
    end,
    resetEggs = function()
        local save = getPlayerSave()
        if save.EggsHatched then
            initialEggCount = save.EggsHatched
            print("âœ… Egg counter reset!")
        end
    end
}

print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
print("â•‘  âœ… PS99 ENHANCED STATS HUD LOADED    â•‘")
print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("")
print("Features:")
print("  â€¢ Player Name")
print("  â€¢ Diamonds (with rate)")
print("  â€¢ Eggs Hatched (total + session)")
print("  â€¢ Active Quest Progress")
print("  â€¢ Timer")
print("")
print("Commands:")
print("  getgenv().statsHUD.close()")
print("  getgenv().statsHUD.open()")
print("  getgenv().statsHUD.toggle()")
print("  getgenv().statsHUD.resetTimer()")
print("  getgenv().statsHUD.resetEggs()")
print("")
