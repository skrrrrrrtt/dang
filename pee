--[[
    Enhanced Christmas 2025 Egg Hatcher
    Automatically detects and hatches rotating Christmas eggs
    By: Modified from griffindoescooking's base
]]--

-- Configuration
local CONFIG = {
    -- Egg paths (these rotate every hour)
    EGGS = {
        "2 | Icy Egg",
        "4 | Pine Tree Egg", 
        "1 | Candy Cane Egg"
    },
    
    -- How many eggs to hatch at once (1, 3, or 8)
    HATCH_AMOUNT = 36,
    
    -- Wait time between hatches
    WAIT_TIME = 0.5,
    
    -- Auto detect which egg is currently available
    AUTO_DETECT = true,
    
    -- Try all eggs in rotation if one fails
    CYCLE_ON_FAIL = true
}

-- Services and Setup
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer

-- Load Client Library
local Client = {}
for _, v in ReplicatedStorage.Library.Client:GetChildren() do
    local success, result = pcall(require, v)
    if success then
        Client[v.Name] = result
    end
end

-- Helper Functions
local function Invoke(eventName, args)
    return Client.Network.Invoke(eventName, unpack(args))
end

local function clickToSkip()
    VirtualUser:Button1Down(Vector2.new(math.huge, math.huge))
    VirtualUser:Button1Up(Vector2.new(math.huge, math.huge))
end

local function waitForEggAnimation(timeout)
    local startTime = tick()
    while tick() - startTime < (timeout or 5) do
        if Workspace.Camera:FindFirstChild("Eggs") then
            return true
        end
        task.wait(0.1)
    end
    return false
end

local function skipEggAnimation()
    while Workspace.Camera:FindFirstChild("Eggs") do
        clickToSkip()
        task.wait(0.05)
    end
end

-- Check if egg is currently available
local function isEggAvailable(eggPath)
    local success, result = pcall(function()
        -- Try to get egg info from the game
        local eggData = ReplicatedStorage.__DIRECTORY.Eggs.Events.Christmas2025:FindFirstChild(eggPath:split(" | ")[1])
        return eggData ~= nil
    end)
    return success and result
end

-- Main Hatch Function
local function hatchEgg(eggPath, amount)
    print(string.format("[HATCH] Attempting: %s (x%d)", eggPath, amount))
    
    -- Try to purchase/hatch
    local success, result = pcall(function()
        return Invoke("Eggs_RequestPurchase", {eggPath, amount})
    end)
    
    if not success then
        warn("[ERROR] Failed to request purchase:", result)
        return false, "purchase_failed"
    end
    
    -- Wait for animation
    if not waitForEggAnimation(5) then
        warn("[ERROR] Egg animation didn't appear (egg might not be available)")
        return false, "not_available"
    end
    
    print("[SKIP] Clicking to skip animation...")
    skipEggAnimation()
    
    print(string.format("[SUCCESS] Hatched %s x%d", eggPath, amount))
    return true, "success"
end

-- Smart egg selector - tries to find which egg is currently active
local function findAvailableEgg()
    for _, eggPath in ipairs(CONFIG.EGGS) do
        if isEggAvailable(eggPath) then
            return eggPath
        end
    end
    return nil
end

-- Main Script
print("=" .. string.rep("=", 50))
print("ðŸŽ„ Christmas 2025 Egg Hatcher Started ðŸŽ„")
print("=" .. string.rep("=", 50))
print("Settings:")
print("  â€¢ Hatch Amount:", CONFIG.HATCH_AMOUNT)
print("  â€¢ Auto Detect:", CONFIG.AUTO_DETECT)
print("  â€¢ Available Eggs:", #CONFIG.EGGS)
for i, egg in ipairs(CONFIG.EGGS) do
    print(string.format("    %d. %s", i, egg))
end
print("=" .. string.rep("=", 50))

local currentIndex = 1
local consecutiveFailures = 0
local totalHatches = 0

-- Main Loop
while task.wait(CONFIG.WAIT_TIME) do
    -- Safety check
    if not LocalPlayer or not LocalPlayer.Character then
        warn("Player left game, stopping...")
        break
    end
    
    -- Get egg to try
    local targetEgg
    if CONFIG.AUTO_DETECT then
        targetEgg = findAvailableEgg()
        if not targetEgg then
            warn("No eggs detected as available, using rotation...")
            targetEgg = CONFIG.EGGS[currentIndex]
        end
    else
        targetEgg = CONFIG.EGGS[currentIndex]
    end
    
    -- Try to hatch
    local success, reason = hatchEgg(targetEgg, CONFIG.HATCH_AMOUNT)
    
    if success then
        totalHatches = totalHatches + 1
        consecutiveFailures = 0
        print(string.format("[STATS] Total hatches: %d", totalHatches))
    else
        consecutiveFailures = consecutiveFailures + 1
        warn(string.format("[FAIL] Failed to hatch %s (Reason: %s)", targetEgg, reason))
        
        if CONFIG.CYCLE_ON_FAIL then
            print("[CYCLE] Trying next egg in rotation...")
            currentIndex = currentIndex % #CONFIG.EGGS + 1
        end
        
        -- If too many failures, increase wait time
        if consecutiveFailures >= 5 then
            warn("[WARNING] Multiple failures, waiting longer...")
            task.wait(5)
            consecutiveFailures = 0
        end
    end
    
    -- Rotate to next egg
    if not CONFIG.CYCLE_ON_FAIL or success then
        currentIndex = currentIndex % #CONFIG.EGGS + 1
    end
end

print("=" .. string.rep("=", 50))
print("ðŸŽ„ Egg Hatcher Stopped ðŸŽ„")
print(string.format("Total Eggs Hatched: %d", totalHatches))
print("=" .. string.rep("=", 50))
