-- ================= CONFIG =================
local CONFIG = {
    AUTO_ROB = false,
    DROP_OFF_TARGET = 20000,
    ROB_DELAY = 1.5,
}
-- =========================================


-- SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CollectionService = game:GetService("CollectionService")

local player = Players.LocalPlayer
local remotes = ReplicatedStorage:WaitForChild("Remotes")

-- REMOTES
local StartATM = remotes:WaitForChild("AttemptATMBustStart")
local FinishATM = remotes:WaitForChild("AttemptATMBustComplete")

-- DATA
local robbedThisRun = 0
local lastCash = 0

-- GET CASH
local function getCash()
    local stats = player:FindFirstChild("leaderstats")
    local cash = stats and stats:FindFirstChild("Cash")
    return cash and cash.Value or 0
end

lastCash = getCash()

-- FORMAT NUMBER
local function formatNumber(num)
    return tostring(num):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "")
end

-- SAFE TELEPORT
local function teleport(cf)
    local char = player.Character
    if char and char.PrimaryPart then
        char.PrimaryPart.Velocity = Vector3.zero
        char:PivotTo(cf + Vector3.new(0, 5, 0))
    end
end

-- FIND AVAILABLE ATM
local function findATM()
    for _, atm in pairs(CollectionService:GetTagged("CriminalATM")) do
        if atm:GetAttribute("State") ~= "Busted" then
            return atm
        end
    end
    return nil
end

-- DROP OFF DELIVERY
local function deliverMoney()
    local drop = workspace.Game.Jobs.CriminalDropOffSpawners
        :FindFirstChild("CriminalDropOffSpawnerPermanent")

    if not drop then return end

    teleport(drop.CFrame)
    task.wait(1)

    local char = player.Character
    if char and char:FindFirstChild("Humanoid") then
        char.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end

    task.wait(3)
    robbedThisRun = 0
    statusLabel.Text = "Robbed: $0"
end

-- ROB ATM
local function robATM(atm)
    teleport(atm.WorldPivot)
    task.wait(0.5)

    StartATM:InvokeServer(atm)
    task.wait(2.5)
    FinishATM:InvokeServer(atm)

    task.wait(2)

    local now = getCash()
    local gained = now - lastCash
    lastCash = now

    if gained > 0 then
        robbedThisRun += gained
        statusLabel.Text = "Robbed: $" .. formatNumber(robbedThisRun)
    end

    if robbedThisRun >= CONFIG.DROP_OFF_TARGET then
        statusLabel.Text = "Delivering..."
        deliverMoney()
    end
end

-- ================= UI =================
local gui = Instance.new("ScreenGui")
gui.Name = "ATM_AutoRob_UI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.25, 0.2)
frame.Position = UDim2.fromScale(0.37, 0.4)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.fromScale(1, 0.25)
title.BackgroundTransparency = 1
title.Text = "ATM Auto Rob"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextScaled = true

statusLabel = Instance.new("TextLabel", frame)
statusLabel.Position = UDim2.fromScale(0, 0.3)
statusLabel.Size = UDim2.fromScale(1, 0.25)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Robbed: $0"
statusLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextScaled = true

local toggle = Instance.new("TextButton", frame)
toggle.Position = UDim2.fromScale(0.1, 0.65)
toggle.Size = UDim2.fromScale(0.8, 0.25)
toggle.Text = "START"
toggle.BackgroundColor3 = Color3.fromRGB(60, 180, 75)
toggle.TextColor3 = Color3.new(1, 1, 1)
toggle.Font = Enum.Font.GothamBold
toggle.TextScaled = true

Instance.new("UICorner", toggle).CornerRadius = UDim.new(0, 8)

toggle.MouseButton1Click:Connect(function()
    CONFIG.AUTO_ROB = not CONFIG.AUTO_ROB
    toggle.Text = CONFIG.AUTO_ROB and "STOP" or "START"
    toggle.BackgroundColor3 = CONFIG.AUTO_ROB
        and Color3.fromRGB(200, 70, 70)
        or Color3.fromRGB(60, 180, 75)
end)

-- MAIN LOOP
task.spawn(function()
    while task.wait(CONFIG.ROB_DELAY) do
        if CONFIG.AUTO_ROB then
            local atm = findATM()
            if atm then
                robATM(atm)
            end
        end
    end
end)
