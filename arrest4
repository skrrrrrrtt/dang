--// AUTO ARREST CRIMINAL - WINDUI FIXED
repeat task.wait() until game:IsLoaded()

if game.PlaceId ~= 3351674303 then
    warn("❌ Wrong game")
    return
end

--// SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

--// SETTINGS
_G.AutoArrestSettings = {
    Enabled = false,
    Target = nil,
    Offset = Vector3.new(0, -3, 0),
    UpdateRate = 0.1,
    AutoSwitch = true,
    MaxDistance = 5000,
}

--// STATS
local Stats = {
    Arrests = 0,
    Target = "None",
    Criminals = 0
}

--// UTIL
local function getRoot(char)
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function isCriminal(plr)
    if not plr.Team then return false end
    local name = plr.Team.Name:lower()
    return name:find("criminal") or name:find("wanted") or name:find("prisoner")
end

local function getNearestCriminal()
    local root = getRoot(LocalPlayer.Character)
    if not root then return nil end

    local closest, dist = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and getRoot(p.Character) and isCriminal(p) then
            local d = (getRoot(p.Character).Position - root.Position).Magnitude
            if d < dist and d < _G.AutoArrestSettings.MaxDistance then
                closest, dist = p, d
            end
        end
    end
    return closest, dist
end

local function followTarget(target)
    if not target or not target.Character then return end
    local root = getRoot(target.Character)
    local myRoot = getRoot(LocalPlayer.Character)
    if not root or not myRoot then return end

    myRoot.CFrame = root.CFrame * CFrame.new(_G.AutoArrestSettings.Offset)
end

local function isArrested(player)
    return not isCriminal(player)
end

--// LOAD WINDUI
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

--// WINDOW
local Window = WindUI:CreateWindow({
    Title = "Auto Arrest Criminal",
    Icon = "shield",
    Author = "Driving Empire",
    Folder = "AutoArrest",
    Size = UDim2.fromOffset(580, 460),
    Transparent = true,
    Theme = "Dark",
})

Window:SetToggleKey(Enum.KeyCode.LeftControl)

--// TABS
local Main = Window:Tab({ Name = "Main", Icon = "play" })
local Settings = Window:Tab({ Name = "Settings", Icon = "settings" })
local StatsTab = Window:Tab({ Name = "Stats", Icon = "bar-chart" })

--// MAIN
Main:Toggle({
    Name = "Enable Auto Arrest",
    Default = false,
    Callback = function(v)
        _G.AutoArrestSettings.Enabled = v
        if not v then
            _G.AutoArrestSettings.Target = nil
            Stats.Target = "None"
        end

        Window:Notify({
            Title = "Auto Arrest",
            Content = v and "Enabled" or "Disabled",
            Duration = 3
        })
    end
})

Main:Button({
    Name = "Find Nearest Criminal",
    Callback = function()
        local crim, dist = getNearestCriminal()
        if crim then
            _G.AutoArrestSettings.Target = crim
            Stats.Target = crim.Name
            Window:Notify({
                Title = "Target Locked",
                Content = crim.Name .. " (" .. math.floor(dist) .. " studs)",
                Duration = 4
            })
        else
            Window:Notify({
                Title = "No Criminals",
                Content = "None nearby",
                Duration = 3
            })
        end
    end
})

--// SETTINGS
Settings:Slider({
    Name = "Height Offset",
    Min = -10,
    Max = 5,
    Default = -3,
    Callback = function(v)
        _G.AutoArrestSettings.Offset = Vector3.new(0, v, 0)
    end
})

Settings:Toggle({
    Name = "Auto Switch Target",
    Default = true,
    Callback = function(v)
        _G.AutoArrestSettings.AutoSwitch = v
    end
})

--// STATS LIVE
task.spawn(function()
    while task.wait(1) do
        StatsTab:Clear()
        StatsTab:Label({ Name = "Total Arrests: " .. Stats.Arrests })
        StatsTab:Label({ Name = "Current Target: " .. Stats.Target })
        StatsTab:Label({ Name = "Criminals Online: " .. Stats.Criminals })
    end
end)

--// MAIN LOOP
task.spawn(function()
    while task.wait(_G.AutoArrestSettings.UpdateRate) do
        if not _G.AutoArrestSettings.Enabled then continue end

        local criminals = {}
        for _, p in pairs(Players:GetPlayers()) do
            if isCriminal(p) then
                table.insert(criminals, p)
            end
        end
        Stats.Criminals = #criminals

        local target = _G.AutoArrestSettings.Target
        if not target or not target.Character then
            local nextTarget = getNearestCriminal()
            if nextTarget then
                _G.AutoArrestSettings.Target = nextTarget
                Stats.Target = nextTarget.Name
            end
            continue
        end

        if isArrested(target) then
            Stats.Arrests += 1
            _G.AutoArrestSettings.Target = nil
            Stats.Target = "None"

            if _G.AutoArrestSettings.AutoSwitch then
                task.wait(0.5)
                local nextTarget = getNearestCriminal()
                if nextTarget then
                    _G.AutoArrestSettings.Target = nextTarget
                    Stats.Target = nextTarget.Name
                end
            end
        else
            followTarget(target)
        end
    end
end)

Window:Notify({
    Title = "Loaded",
    Content = "Auto Arrest Ready (WindUI)",
    Duration = 5
})

print("✅ Auto Arrest Criminal loaded successfully")
