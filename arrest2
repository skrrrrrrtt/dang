-- Auto Arrest Criminal for Driving Empire with WindUI
-- Fixed version with error handling and fallback GUI

repeat wait() until game:IsLoaded()
if game.PlaceId ~= 3351674303 then
    warn("This script is for Driving Empire only!")
    return
end

print("Loading Auto Arrest Script...")

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer

-- Settings
_G.AutoArrestSettings = {
    Enabled = false,
    TargetCriminal = nil,
    Following = false,
    OffsetY = -3,
    OffsetX = 0,
    OffsetZ = 0,
    UpdateRate = 0.1,
    MaxDistance = 5000,
    AutoSwitch = true,
    UseVehicle = false,
    NotifyArrest = true,
}

-- Stats
local Stats = {
    TotalArrests = 0,
    SessionStart = tick(),
    CurrentTarget = "None",
    CriminalsOnline = 0,
}

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘                    CORE FUNCTIONS                            â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function GetCurrentVehicle()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") 
        and LocalPlayer.Character.Humanoid.SeatPart 
        and LocalPlayer.Character.Humanoid.SeatPart.Parent
end

function CharacterTP(cframe)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = cframe
        return true
    end
    return false
end

function VehicleTP(cframe)
    local vehicle = GetCurrentVehicle()
    if vehicle then
        vehicle:SetPrimaryPartCFrame(cframe)
        return true
    end
    return false
end

function SpawnVehicle(carName)
    local args = {[1] = "Spawn", [2] = carName or "Dart"}
    ReplicatedStorage.Remotes.VehicleEvent:FireServer(unpack(args))
end

function DespawnVehicle()
    local args = {[1] = "Despawn"}
    ReplicatedStorage.Remotes.VehicleEvent:FireServer(unpack(args))
end

function IsCriminal(player)
    local isCrim = false
    
    pcall(function()
        if player.Team and player.Team.Name then
            local teamName = player.Team.Name:lower()
            if teamName:find("criminal") or teamName:find("crim") or 
               teamName:find("prisoner") or teamName:find("bad") or
               teamName:find("wanted") then
                isCrim = true
            end
        end
        
        if not isCrim and player.Character then
            local tags = {"Criminal", "CriminalTag", "Wanted", "Bad", "Prisoner", "Crim", "Bounty"}
            for _, tagName in pairs(tags) do
                if player.Character:FindFirstChild(tagName) then
                    isCrim = true
                    break
                end
            end
        end
    end)
    
    return isCrim
end

function FindNearestCriminal()
    local nearestCriminal = nil
    local shortestDistance = math.huge
    
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return nil
    end
    
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if IsCriminal(player) then
                local distance = (player.Character.HumanoidRootPart.Position - myPos).Magnitude
                
                if distance < shortestDistance and distance < _G.AutoArrestSettings.MaxDistance then
                    shortestDistance = distance
                    nearestCriminal = player
                end
            end
        end
    end
    
    return nearestCriminal, shortestDistance
end

function GetAllCriminals()
    local criminals = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and IsCriminal(player) then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local distance = 999999
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    distance = (player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                end
                
                table.insert(criminals, {
                    player = player,
                    name = player.Name,
                    distance = distance
                })
            end
        end
    end
    
    table.sort(criminals, function(a, b)
        return a.distance < b.distance
    end)
    
    return criminals
end

function FollowCriminal(criminal)
    if not criminal or not criminal.Character or not criminal.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local criminalRoot = criminal.Character.HumanoidRootPart
    local targetCFrame = criminalRoot.CFrame * CFrame.new(
        _G.AutoArrestSettings.OffsetX,
        _G.AutoArrestSettings.OffsetY,
        _G.AutoArrestSettings.OffsetZ
    )
    
    local success = false
    if _G.AutoArrestSettings.UseVehicle then
        success = VehicleTP(targetCFrame)
        if not success then
            success = CharacterTP(targetCFrame)
        end
    else
        success = CharacterTP(targetCFrame)
    end
    
    return success
end

function IsPlayerArrested(player)
    return not IsCriminal(player)
end

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘                    TRY LOADING WINDUI                        â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local UILoaded = false
local Fluent = nil

print("Attempting to load WindUI...")

local success, result = pcall(function()
    return loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
end)

if success and result then
    Fluent = result
    UILoaded = true
    print("âœ“ WindUI loaded successfully!")
else
    warn("Failed to load WindUI:", result)
    print("Attempting Fluent UI fallback...")
    
    success, result = pcall(function()
        return loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
    end)
    
    if success and result then
        Fluent = result
        UILoaded = true
        print("âœ“ Fluent UI loaded successfully!")
    else
        warn("Failed to load Fluent UI:", result)
        print("Using fallback simple GUI...")
    end
end

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘                WINDUI / FLUENT INTERFACE                     â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if UILoaded and Fluent then
    local Window = Fluent:CreateWindow({
        Title = "Auto Arrest Criminal",
        SubTitle = "Driving Empire",
        TabWidth = 160,
        Size = UDim2.fromOffset(580, 460),
        Acrylic = true,
        Theme = "Darker",
        MinimizeKey = Enum.KeyCode.LeftControl
    })

    local Tabs = {
        Main = Window:AddTab({ Title = "Main", Icon = "shield" }),
        Settings = Window:AddTab({ Title = "Settings", Icon = "settings" }),
        Stats = Window:AddTab({ Title = "Stats", Icon = "bar-chart" })
    }

    -- Main Tab
    Tabs.Main:AddToggle("AutoArrest", {
        Title = "Enable Auto Arrest",
        Description = "Automatically arrest criminals",
        Default = false,
        Callback = function(Value)
            _G.AutoArrestSettings.Enabled = Value
            Fluent:Notify({
                Title = "Auto Arrest",
                Content = Value and "Enabled! Finding criminals..." or "Disabled",
                Duration = 3
            })
            if not Value then
                _G.AutoArrestSettings.Following = false
                _G.AutoArrestSettings.TargetCriminal = nil
            end
        end
    })

    Tabs.Main:AddButton({
        Title = "Find Nearest Criminal",
        Description = "Find and target nearest criminal",
        Callback = function()
            local criminal, distance = FindNearestCriminal()
            if criminal then
                _G.AutoArrestSettings.TargetCriminal = criminal
                Fluent:Notify({
                    Title = "Criminal Found",
                    Content = string.format("Target: %s (%.0f studs)", criminal.Name, distance),
                    Duration = 4
                })
            else
                Fluent:Notify({
                    Title = "No Criminals",
                    Content = "No criminals found nearby!",
                    Duration = 3
                })
            end
        end
    })

    -- Settings Tab
    Tabs.Settings:AddSlider("OffsetY", {
        Title = "Y Offset (Height)",
        Description = "Height offset (negative = below)",
        Default = -3,
        Min = -10,
        Max = 10,
        Rounding = 1,
        Callback = function(Value)
            _G.AutoArrestSettings.OffsetY = Value
        end
    })

    Tabs.Settings:AddToggle("AutoSwitch", {
        Title = "Auto Switch Target",
        Description = "Auto find next criminal when arrested",
        Default = true,
        Callback = function(Value)
            _G.AutoArrestSettings.AutoSwitch = Value
        end
    })

    Tabs.Settings:AddToggle("UseVehicle", {
        Title = "Use Vehicle",
        Description = "Teleport with vehicle",
        Default = false,
        Callback = function(Value)
            _G.AutoArrestSettings.UseVehicle = Value
        end
    })

    -- Stats Tab
    local TotalArrestsParagraph = Tabs.Stats:AddParagraph({
        Title = "Total Arrests",
        Content = "0 arrests assisted"
    })

    local CurrentTargetParagraph = Tabs.Stats:AddParagraph({
        Title = "Current Target",
        Content = "None"
    })

    -- Update stats display
    spawn(function()
        while wait(1) do
            TotalArrestsParagraph:SetDesc(string.format("%d arrests assisted", Stats.TotalArrests))
            CurrentTargetParagraph:SetDesc(Stats.CurrentTarget)
        end
    end)

    Fluent:Notify({
        Title = "Auto Arrest Loaded",
        Content = "Ready to arrest criminals!",
        Duration = 5
    })

else
-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘                    FALLBACK SIMPLE GUI                       â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    print("Creating fallback GUI...")
    
    local old = CoreGui:FindFirstChild("AutoArrestSimple")
    if old then old:Destroy() end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AutoArrestSimple"
    ScreenGui.Parent = CoreGui

    local MainFrame = Instance.new("Frame")
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -175, 0.5, -150)
    MainFrame.Size = UDim2.new(0, 350, 0, 300)
    MainFrame.Active = true
    MainFrame.Draggable = true

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 10)
    UICorner.Parent = MainFrame

    local UIStroke = Instance.new("UIStroke")
    UIStroke.Color = Color3.fromRGB(255, 60, 60)
    UIStroke.Thickness = 2
    UIStroke.Parent = MainFrame

    local Title = Instance.new("TextLabel")
    Title.Parent = MainFrame
    Title.BackgroundTransparency = 1
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.Font = Enum.Font.GothamBlack
    Title.Text = "ğŸš” AUTO ARREST"
    Title.TextColor3 = Color3.fromRGB(255, 60, 60)
    Title.TextSize = 16

    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Parent = MainFrame
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Position = UDim2.new(0, 10, 0, 50)
    StatusLabel.Size = UDim2.new(1, -20, 0, 60)
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.Text = "Status: Disabled\nTarget: None\nArrests: 0"
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusLabel.TextSize = 12
    StatusLabel.TextWrapped = true
    StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Parent = MainFrame
    ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    ToggleButton.Position = UDim2.new(0.1, 0, 0, 120)
    ToggleButton.Size = UDim2.new(0.8, 0, 0, 40)
    ToggleButton.Font = Enum.Font.GothamBlack
    ToggleButton.Text = "START AUTO ARREST"
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.TextSize = 14
    Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 8)

    ToggleButton.MouseButton1Click:Connect(function()
        _G.AutoArrestSettings.Enabled = not _G.AutoArrestSettings.Enabled
        if _G.AutoArrestSettings.Enabled then
            ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 255, 100)
            ToggleButton.Text = "STOP AUTO ARREST"
        else
            ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
            ToggleButton.Text = "START AUTO ARREST"
            _G.AutoArrestSettings.Following = false
            _G.AutoArrestSettings.TargetCriminal = nil
        end
    end)

    local FindButton = Instance.new("TextButton")
    FindButton.Parent = MainFrame
    FindButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    FindButton.Position = UDim2.new(0.1, 0, 0, 170)
    FindButton.Size = UDim2.new(0.8, 0, 0, 35)
    FindButton.Font = Enum.Font.Gotham
    FindButton.Text = "Find Nearest Criminal"
    FindButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    FindButton.TextSize = 12
    Instance.new("UICorner", FindButton).CornerRadius = UDim.new(0, 6)

    FindButton.MouseButton1Click:Connect(function()
        local criminal, distance = FindNearestCriminal()
        if criminal then
            _G.AutoArrestSettings.TargetCriminal = criminal
            Stats.CurrentTarget = criminal.Name
        end
    end)

    local CloseButton = Instance.new("TextButton")
    CloseButton.Parent = MainFrame
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    CloseButton.Position = UDim2.new(1, -35, 0, 5)
    CloseButton.Size = UDim2.new(0, 30, 0, 30)
    CloseButton.Font = Enum.Font.GothamBlack
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 16
    Instance.new("UICorner", CloseButton).CornerRadius = UDim.new(0, 6)

    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
    end)

    -- Update status
    spawn(function()
        while wait(0.5) do
            if ScreenGui and ScreenGui.Parent then
                local statusText = string.format(
                    "Status: %s\nTarget: %s\nArrests: %d\nCriminals: %d",
                    _G.AutoArrestSettings.Enabled and "ACTIVE" or "Disabled",
                    Stats.CurrentTarget,
                    Stats.TotalArrests,
                    Stats.CriminalsOnline
                )
                StatusLabel.Text = statusText
            end
        end
    end)

    print("âœ“ Fallback GUI created!")
end

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘                    MAIN ARREST LOOP                          â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

spawn(function()
    while true do
        wait(_G.AutoArrestSettings.UpdateRate)
        
        if _G.AutoArrestSettings.Enabled then
            -- Update criminals count
            Stats.CriminalsOnline = #GetAllCriminals()
            
            -- Find target if we don't have one
            if not _G.AutoArrestSettings.TargetCriminal or not _G.AutoArrestSettings.TargetCriminal.Character then
                local criminal, distance = FindNearestCriminal()
                if criminal then
                    _G.AutoArrestSettings.TargetCriminal = criminal
                    Stats.CurrentTarget = criminal.Name
                    _G.AutoArrestSettings.Following = true
                    print(string.format("âœ“ New target: %s (%.0f studs)", criminal.Name, distance))
                end
            end
            
            -- Follow current target
            if _G.AutoArrestSettings.TargetCriminal and _G.AutoArrestSettings.Following then
                local criminal = _G.AutoArrestSettings.TargetCriminal
                
                -- Check if arrested
                if IsPlayerArrested(criminal) then
                    Stats.TotalArrests = Stats.TotalArrests + 1
                    print(string.format("âœ“ %s was arrested! Total: %d", criminal.Name, Stats.TotalArrests))
                    
                    -- Clear target
                    _G.AutoArrestSettings.TargetCriminal = nil
                    _G.AutoArrestSettings.Following = false
                    Stats.CurrentTarget = "None"
                    
                    -- Find next if auto switch enabled
                    if _G.AutoArrestSettings.AutoSwitch then
                        wait(1)
                        local nextCriminal, dist = FindNearestCriminal()
                        if nextCriminal then
                            _G.AutoArrestSettings.TargetCriminal = nextCriminal
                            Stats.CurrentTarget = nextCriminal.Name
                            _G.AutoArrestSettings.Following = true
                        end
                    end
                else
                    -- Follow criminal
                    FollowCriminal(criminal)
                end
            end
        end
    end
end)

print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
print("â•‘   AUTO ARREST LOADED SUCCESSFULLY      â•‘")
print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
print("â•‘ â€¢ Auto find & follow criminals         â•‘")
print("â•‘ â€¢ Teleport under them                  â•‘")
print("â•‘ â€¢ Wait for arrest                      â•‘")
print("â•‘ â€¢ Auto switch to next                  â•‘")
print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

end
