local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Wait for game to load
wait(3)

-- Get required modules
local Library = ReplicatedStorage.Library
local Client = Library.Client
local Save = require(Client.Save)
local QuestCmds = require(Client.QuestCmds)
local Network = require(Client.Network)

-- Settings
local COOLDOWN_TIME = 120 -- 2 minutes cooldown between spawns

-- Get player save
local function getPlayerSave()
    return Save.GetSaves()[LocalPlayer]
end

-- Get goals (quests)
local function getGoals()
    return getPlayerSave().Goals
end

-- Fire network event
local function Fire(name, ...)
    return Network.Fire(name, ...)
end

-- Invoke network function
local function Invoke(name, ...)
    return Network.Invoke(name, ...)
end

-- Get all quests with details
local function getQuests()
    local questTable = {}
    for _, goal in getGoals() do
        local title = QuestCmds.MakeTitle(goal)
        
        -- Get progress from the goal object
        local progress = 0
        local maxProgress = goal.Amount or 0
        
        -- Try to find progress field
        for key, value in pairs(goal) do
            if key:lower():find("progress") or key == "_am" then
                progress = value
            end
        end
        
        table.insert(questTable, {
            Title = title,
            Goal = goal,
            Type = goal.Type,
            Progress = progress,
            MaxProgress = maxProgress,
            Stars = goal.Stars or 0,
            UID = goal.UID
        })
    end
    return questTable
end

-- Check if quest is an event quest
local function isEventQuest(title)
    local eventTypes = {
        "coin jar",
        "comet",
        "pinata",
        "lucky block"
    }
    
    for _, eventType in ipairs(eventTypes) do
        if title:lower():find(eventType) then
            return eventType
        end
    end
    return nil
end

-- Get the zone name from quest title
local function getZoneFromTitle(title)
    if title:lower():find("best area") then
        -- Get the player's best/highest zone
        local highestZone = getPlayerSave().HighestZone or "Spawn"
        return highestZone
    end
    -- You can add more zone detection logic here
    return nil
end

-- Spawn and complete event quest
local function completeEventQuest(quest, eventType, zone)
    print(string.format("\n[AUTO EVENT] Starting quest: %s", quest.Title))
    print(string.format("[AUTO EVENT] Need to spawn %d %ss", quest.MaxProgress - quest.Progress, eventType))
    
    local eventsToSpawn = quest.MaxProgress - quest.Progress
    
    for i = 1, eventsToSpawn do
        if not getGoals()[quest.UID] then
            print("[AUTO EVENT] Quest completed!")
            break
        end
        
        print(string.format("[AUTO EVENT] Spawning %s %d/%d...", eventType, i, eventsToSpawn))
        
        -- Request the random event based on type
        if eventType == "coin jar" then
            Invoke("Random Events: Request Coin Jar Data", zone)
        elseif eventType == "comet" then
            Invoke("Random Events: Request Comet Data", zone)
        elseif eventType == "pinata" then
            Invoke("Random Events: Request Pinata Data", zone)
        elseif eventType == "lucky block" then
            Invoke("Random Events: Request Lucky Block Data", zone)
        end
        
        wait(1) -- Wait for event to spawn
        
        -- Break the event (you'll need to implement breaking logic)
        print(string.format("[AUTO EVENT] Breaking %s...", eventType))
        wait(2)
        
        -- Wait cooldown before next spawn
        if i < eventsToSpawn then
            print(string.format("[AUTO EVENT] Waiting %d seconds cooldown...", COOLDOWN_TIME))
            wait(COOLDOWN_TIME)
        end
    end
end

-- Main auto-complete function
local function autoCompleteEventQuests()
    print("\n=== CHECKING FOR EVENT QUESTS ===\n")
    
    local quests = getQuests()
    
    for i, quest in ipairs(quests) do
        print(string.format("Quest %d: %s", i, quest.Title))
        print(string.format("  Progress: %d/%d ⭐%d", quest.Progress, quest.MaxProgress, quest.Stars))
        
        local eventType = isEventQuest(quest.Title)
        
        if eventType then
            print(string.format("  [DETECTED] Event quest type: %s", eventType))
            
            local zone = getZoneFromTitle(quest.Title)
            if zone then
                print(string.format("  [ZONE] Target zone: %s", zone))
                
                -- Start completing the quest
                task.spawn(function()
                    completeEventQuest(quest, eventType, zone)
                end)
            else
                print("  [ERROR] Could not determine zone")
            end
        end
        
        print("---")
    end
    
    print("\n================================")
end

-- Run the auto-completer
autoCompleteEventQuests()

-- Make functions callable
_G.autoCompleteEventQuests = autoCompleteEventQuests
_G.getQuests = getQuests

print("\n✅ Event quest auto-completer loaded!")
print("Type '_G.autoCompleteEventQuests()' to run again")
