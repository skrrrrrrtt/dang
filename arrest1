-- Auto Arrest Criminal for Driving Empire with WindUI
-- Finds criminals, teleports under them, follows until arrested

repeat wait() until game:IsLoaded()
if game.PlaceId == 3351674303 then

-- Load WindUI
local Fluent = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- Settings
_G.AutoArrestSettings = {
    Enabled = false,
    TargetCriminal = nil,
    Following = false,
    OffsetY = -3, -- Studs below criminal
    OffsetX = 0,
    OffsetZ = 0,
    UpdateRate = 0.1,
    MaxDistance = 5000,
    AutoSwitch = true, -- Auto switch to next criminal when current is arrested
    UseVehicle = false,
    NotifyArrest = true,
}

-- Stats
local Stats = {
    TotalArrests = 0,
    SessionStart = tick(),
    CurrentTarget = "None",
    CriminalsOnline = 0,
}

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    CORE FUNCTIONS                            ║
-- ╚══════════════════════════════════════════════════════════════╝

function GetCurrentVehicle()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") 
        and LocalPlayer.Character.Humanoid.SeatPart 
        and LocalPlayer.Character.Humanoid.SeatPart.Parent
end

function CharacterTP(cframe)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = cframe
        return true
    end
    return false
end

function VehicleTP(cframe)
    local vehicle = GetCurrentVehicle()
    if vehicle then
        vehicle:SetPrimaryPartCFrame(cframe)
        return true
    end
    return false
end

function SpawnVehicle(carName)
    local args = {[1] = "Spawn", [2] = carName or "Dart"}
    ReplicatedStorage.Remotes.VehicleEvent:FireServer(unpack(args))
end

function DespawnVehicle()
    local args = {[1] = "Despawn"}
    ReplicatedStorage.Remotes.VehicleEvent:FireServer(unpack(args))
end

-- Check if player is criminal
function IsCriminal(player)
    local isCrim = false
    
    pcall(function()
        -- Method 1: Check team
        if player.Team and player.Team.Name then
            local teamName = player.Team.Name:lower()
            if teamName:find("criminal") or teamName:find("crim") or 
               teamName:find("prisoner") or teamName:find("bad") or
               teamName:find("wanted") then
                isCrim = true
            end
        end
        
        -- Method 2: Check character tags
        if not isCrim and player.Character then
            local tags = {
                "Criminal", "CriminalTag", "Wanted", "Bad", "Prisoner",
                "Crim", "Bounty"
            }
            
            for _, tagName in pairs(tags) do
                if player.Character:FindFirstChild(tagName) then
                    isCrim = true
                    break
                end
            end
        end
        
        -- Method 3: Check for criminal-specific attributes
        if not isCrim and player:GetAttribute then
            if player:GetAttribute("Criminal") or player:GetAttribute("Wanted") then
                isCrim = true
            end
        end
    end)
    
    return isCrim
end

-- Find nearest criminal
function FindNearestCriminal()
    local nearestCriminal = nil
    local shortestDistance = math.huge
    
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return nil
    end
    
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if IsCriminal(player) then
                local distance = (player.Character.HumanoidRootPart.Position - myPos).Magnitude
                
                if distance < shortestDistance and distance < _G.AutoArrestSettings.MaxDistance then
                    shortestDistance = distance
                    nearestCriminal = player
                end
            end
        end
    end
    
    return nearestCriminal, shortestDistance
end

-- Get all criminals
function GetAllCriminals()
    local criminals = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and IsCriminal(player) then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local distance = 999999
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    distance = (player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                end
                
                table.insert(criminals, {
                    player = player,
                    name = player.Name,
                    distance = distance
                })
            end
        end
    end
    
    -- Sort by distance
    table.sort(criminals, function(a, b)
        return a.distance < b.distance
    end)
    
    return criminals
end

-- Follow criminal (teleport under them)
function FollowCriminal(criminal)
    if not criminal or not criminal.Character or not criminal.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    -- Get criminal position with offset
    local criminalRoot = criminal.Character.HumanoidRootPart
    local targetCFrame = criminalRoot.CFrame * CFrame.new(
        _G.AutoArrestSettings.OffsetX,
        _G.AutoArrestSettings.OffsetY,
        _G.AutoArrestSettings.OffsetZ
    )
    
    -- Teleport based on settings
    local success = false
    if _G.AutoArrestSettings.UseVehicle then
        success = VehicleTP(targetCFrame)
        if not success then
            success = CharacterTP(targetCFrame)
        end
    else
        success = CharacterTP(targetCFrame)
    end
    
    return success
end

-- Check if player was arrested
function IsPlayerArrested(player)
    return not IsCriminal(player)
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    WINDUI INTERFACE                          ║
-- ╚══════════════════════════════════════════════════════════════╝

local Window = Fluent:CreateWindow({
    Title = "Auto Arrest Criminal",
    SubTitle = "Driving Empire",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Darker",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "shield" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" }),
    Stats = Window:AddTab({ Title = "Stats", Icon = "bar-chart" }),
    Info = Window:AddTab({ Title = "Info", Icon = "info" })
}

-- ═══════════════════ MAIN TAB ═══════════════════

local MainSection = Tabs.Main:AddSection("Auto Arrest")

local AutoArrestToggle = Tabs.Main:AddToggle("AutoArrest", {
    Title = "Enable Auto Arrest",
    Description = "Automatically arrest criminals",
    Default = false
})

AutoArrestToggle:OnChanged(function(Value)
    _G.AutoArrestSettings.Enabled = Value
    
    if Value then
        Fluent:Notify({
            Title = "Auto Arrest",
            Content = "Auto Arrest Enabled! Finding criminals...",
            Duration = 3
        })
    else
        Fluent:Notify({
            Title = "Auto Arrest",
            Content = "Auto Arrest Disabled",
            Duration = 3
        })
        _G.AutoArrestSettings.Following = false
        _G.AutoArrestSettings.TargetCriminal = nil
    end
end)

local ManualSection = Tabs.Main:AddSection("Manual Actions")

Tabs.Main:AddButton({
    Title = "Find Nearest Criminal",
    Description = "Find and target nearest criminal",
    Callback = function()
        local criminal, distance = FindNearestCriminal()
        if criminal then
            _G.AutoArrestSettings.TargetCriminal = criminal
            Fluent:Notify({
                Title = "Criminal Found",
                Content = string.format("Target: %s (%.0f studs away)", criminal.Name, distance),
                Duration = 4
            })
        else
            Fluent:Notify({
                Title = "No Criminals",
                Content = "No criminals found nearby!",
                Duration = 3
            })
        end
    end
})

Tabs.Main:AddButton({
    Title = "Teleport to Target",
    Description = "Teleport under current target",
    Callback = function()
        if _G.AutoArrestSettings.TargetCriminal then
            if FollowCriminal(_G.AutoArrestSettings.TargetCriminal) then
                Fluent:Notify({
                    Title = "Teleported",
                    Content = "Teleported to " .. _G.AutoArrestSettings.TargetCriminal.Name,
                    Duration = 2
                })
            else
                Fluent:Notify({
                    Title = "Teleport Failed",
                    Content = "Could not teleport to target",
                    Duration = 3
                })
            end
        else
            Fluent:Notify({
                Title = "No Target",
                Content = "Please find a criminal first!",
                Duration = 3
            })
        end
    end
})

Tabs.Main:AddButton({
    Title = "Clear Target",
    Description = "Clear current criminal target",
    Callback = function()
        _G.AutoArrestSettings.TargetCriminal = nil
        _G.AutoArrestSettings.Following = false
        Stats.CurrentTarget = "None"
        Fluent:Notify({
            Title = "Target Cleared",
            Content = "Criminal target cleared",
            Duration = 2
        })
    end
})

local CriminalListSection = Tabs.Main:AddSection("Criminal List")

local CriminalListLabel = Tabs.Main:AddParagraph({
    Title = "Criminals Online",
    Content = "No criminals detected"
})

-- ═══════════════════ SETTINGS TAB ═══════════════════

local OffsetSection = Tabs.Settings:AddSection("Position Offset")

local OffsetYSlider = Tabs.Settings:AddSlider("OffsetY", {
    Title = "Y Offset (Height)",
    Description = "How far below the criminal (negative = below)",
    Default = -3,
    Min = -10,
    Max = 10,
    Rounding = 1,
    Callback = function(Value)
        _G.AutoArrestSettings.OffsetY = Value
    end
})

local OffsetXSlider = Tabs.Settings:AddSlider("OffsetX", {
    Title = "X Offset (Side)",
    Description = "Side offset from criminal",
    Default = 0,
    Min = -10,
    Max = 10,
    Rounding = 1,
    Callback = function(Value)
        _G.AutoArrestSettings.OffsetX = Value
    end
})

local OffsetZSlider = Tabs.Settings:AddSlider("OffsetZ", {
    Title = "Z Offset (Forward/Back)",
    Description = "Forward/backward offset",
    Default = 0,
    Min = -10,
    Max = 10,
    Rounding = 1,
    Callback = function(Value)
        _G.AutoArrestSettings.OffsetZ = Value
    end
})

local BehaviorSection = Tabs.Settings:AddSection("Behavior")

local AutoSwitchToggle = Tabs.Settings:AddToggle("AutoSwitch", {
    Title = "Auto Switch Target",
    Description = "Automatically find next criminal when current is arrested",
    Default = true
})

AutoSwitchToggle:OnChanged(function(Value)
    _G.AutoArrestSettings.AutoSwitch = Value
end)

local NotifyToggle = Tabs.Settings:AddToggle("NotifyArrest", {
    Title = "Notify on Arrest",
    Description = "Show notification when criminal is arrested",
    Default = true
})

NotifyToggle:OnChanged(function(Value)
    _G.AutoArrestSettings.NotifyArrest = Value
end)

local UseVehicleToggle = Tabs.Settings:AddToggle("UseVehicle", {
    Title = "Use Vehicle",
    Description = "Teleport with vehicle instead of character",
    Default = false
})

UseVehicleToggle:OnChanged(function(Value)
    _G.AutoArrestSettings.UseVehicle = Value
end)

local UpdateRateSlider = Tabs.Settings:AddSlider("UpdateRate", {
    Title = "Update Rate",
    Description = "How fast to follow (lower = faster)",
    Default = 0.1,
    Min = 0.05,
    Max = 1,
    Rounding = 2,
    Callback = function(Value)
        _G.AutoArrestSettings.UpdateRate = Value
    end
})

local MaxDistanceSlider = Tabs.Settings:AddSlider("MaxDistance", {
    Title = "Max Detection Distance",
    Description = "Maximum distance to detect criminals (studs)",
    Default = 5000,
    Min = 100,
    Max = 10000,
    Rounding = 0,
    Callback = function(Value)
        _G.AutoArrestSettings.MaxDistance = Value
    end
})

-- ═══════════════════ STATS TAB ═══════════════════

local StatsSection = Tabs.Stats:AddSection("Session Statistics")

local TotalArrestsParagraph = Tabs.Stats:AddParagraph({
    Title = "Total Assists",
    Content = "0 arrests assisted"
})

local SessionTimeParagraph = Tabs.Stats:AddParagraph({
    Title = "Session Time",
    Content = "0 minutes"
})

local CurrentTargetParagraph = Tabs.Stats:AddParagraph({
    Title = "Current Target",
    Content = "None"
})

local CriminalsOnlineParagraph = Tabs.Stats:AddParagraph({
    Title = "Criminals Online",
    Content = "0 criminals"
})

Tabs.Stats:AddButton({
    Title = "Reset Stats",
    Description = "Reset session statistics",
    Callback = function()
        Stats.TotalArrests = 0
        Stats.SessionStart = tick()
        Fluent:Notify({
            Title = "Stats Reset",
            Content = "Session statistics have been reset",
            Duration = 2
        })
    end
})

-- ═══════════════════ INFO TAB ═══════════════════

Tabs.Info:AddParagraph({
    Title = "How It Works",
    Content = "1. Enable Auto Arrest to start\n2. Script finds nearest criminal\n3. Teleports under them continuously\n4. When arrested, finds next criminal\n5. Repeat until disabled"
})

Tabs.Info:AddParagraph({
    Title = "Tips",
    Content = "• Adjust Y Offset to position yourself under criminal\n• Use negative values for Y to stay below\n• Lower update rate = faster following\n• Enable Auto Switch for continuous farming\n• Disable vehicle mode if you want to walk"
})

Tabs.Info:AddParagraph({
    Title = "Controls",
    Content = "• Left Control: Minimize window\n• Drag title: Move window\n• Close button: Hide (still runs)"
})

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    MAIN LOOP                                 ║
-- ╚══════════════════════════════════════════════════════════════╝

-- Auto Arrest Loop
spawn(function()
    while true do
        wait(_G.AutoArrestSettings.UpdateRate)
        
        if _G.AutoArrestSettings.Enabled then
            -- Find target if we don't have one
            if not _G.AutoArrestSettings.TargetCriminal or not _G.AutoArrestSettings.TargetCriminal.Character then
                local criminal, distance = FindNearestCriminal()
                if criminal then
                    _G.AutoArrestSettings.TargetCriminal = criminal
                    Stats.CurrentTarget = criminal.Name
                    _G.AutoArrestSettings.Following = true
                    
                    Fluent:Notify({
                        Title = "New Target",
                        Content = string.format("Targeting: %s (%.0f studs)", criminal.Name, distance),
                        Duration = 3
                    })
                end
            end
            
            -- Follow current target
            if _G.AutoArrestSettings.TargetCriminal and _G.AutoArrestSettings.Following then
                local criminal = _G.AutoArrestSettings.TargetCriminal
                
                -- Check if criminal was arrested
                if IsPlayerArrested(criminal) then
                    Stats.TotalArrests = Stats.TotalArrests + 1
                    
                    if _G.AutoArrestSettings.NotifyArrest then
                        Fluent:Notify({
                            Title = "Criminal Arrested!",
                            Content = string.format("%s was arrested! Total: %d", criminal.Name, Stats.TotalArrests),
                            Duration = 4
                        })
                    end
                    
                    -- Clear target
                    _G.AutoArrestSettings.TargetCriminal = nil
                    _G.AutoArrestSettings.Following = false
                    Stats.CurrentTarget = "None"
                    
                    -- Find next criminal if auto switch enabled
                    if _G.AutoArrestSettings.AutoSwitch then
                        wait(1) -- Small delay before finding next
                        local nextCriminal, dist = FindNearestCriminal()
                        if nextCriminal then
                            _G.AutoArrestSettings.TargetCriminal = nextCriminal
                            Stats.CurrentTarget = nextCriminal.Name
                            _G.AutoArrestSettings.Following = true
                        end
                    end
                else
                    -- Follow criminal
                    FollowCriminal(criminal)
                end
            end
        end
    end
end)

-- Update Stats Display
spawn(function()
    while true do
        wait(1)
        
        -- Update criminal list
        local criminals = GetAllCriminals()
        Stats.CriminalsOnline = #criminals
        
        local listText = ""
        if #criminals == 0 then
            listText = "No criminals detected"
        else
            for i, crim in ipairs(criminals) do
                if i <= 5 then -- Show only first 5
                    listText = listText .. string.format("%d. %s (%.0f studs)\n", i, crim.name, crim.distance)
                end
            end
            if #criminals > 5 then
                listText = listText .. string.format("... and %d more", #criminals - 5)
            end
        end
        
        CriminalListLabel:SetDesc(listText)
        
        -- Update stats
        TotalArrestsParagraph:SetDesc(string.format("%d arrests assisted this session", Stats.TotalArrests))
        
        local sessionTime = (tick() - Stats.SessionStart) / 60
        SessionTimeParagraph:SetDesc(string.format("%.1f minutes", sessionTime))
        
        CurrentTargetParagraph:SetDesc(Stats.CurrentTarget)
        CriminalsOnlineParagraph:SetDesc(string.format("%d criminals online", Stats.CriminalsOnline))
    end
end)

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    STARTUP                                   ║
-- ╚══════════════════════════════════════════════════════════════╝

Fluent:Notify({
    Title = "Auto Arrest Loaded",
    Content = "Ready to arrest criminals! Enable in Main tab.",
    Duration = 5
})

print("╔════════════════════════════════════════╗")
print("║   AUTO ARREST CRIMINAL LOADED          ║")
print("╠════════════════════════════════════════╣")
print("║ Features:                              ║")
print("║ • Auto find & follow criminals         ║")
print("║ • Teleport under them                  ║")
print("║ • Wait for arrest                      ║")
print("║ • Auto switch to next                  ║")
print("╚════════════════════════════════════════╝")

end
