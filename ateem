-- ╔══════════════════════════════════════════════════════════════╗
-- ║       ADVANCED AUTO ROB ATM - PROPER WINDUI SYNTAX           ║
-- ║                  Driving Empire                              ║
-- ╚══════════════════════════════════════════════════════════════╝

repeat wait() until game:IsLoaded()
if game.PlaceId ~= 3351674303 then
    warn("This script is for Driving Empire only!")
    return
end

print("Loading Auto Rob ATM...")

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    SERVICES & VARIABLES                      ║
-- ╚══════════════════════════════════════════════════════════════╝

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CollectionService = game:GetService("CollectionService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- Settings
_G.AutoRobSettings = {
    Enabled = false,
    TargetAmount = 50000,
    AutoDeliver = true,
    UseNilATMs = true,
    MaxNoATMRetries = 5,
}

-- Stats
local Stats = {
    TotalRobbed = 0,
    TotalDelivered = 0,
    ATMsRobbed = 0,
    SessionStart = tick(),
    NoATMCount = 0,
}

local isAutoRobActive = false
local isDeliveryInProgress = false

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    UTILITY FUNCTIONS                         ║
-- ╚══════════════════════════════════════════════════════════════╝

local function formatNumber(num)
    local formatted = tostring(num)
    local result = ""
    local count = 0
    for i = #formatted, 1, -1 do
        result = formatted:sub(i, i) .. result
        count = count + 1
        if count % 3 == 0 and i > 1 then
            result = "," .. result
        end
    end
    return result
end

local function safeTP(targetCFrame)
    if Character and Character.PrimaryPart then
        Character.PrimaryPart.Velocity = Vector3.zero
        Character:PivotTo(targetCFrame)
        LocalPlayer.ReplicationFocus = nil
    end
end

local function getRobbedAmount()
    local success, amount = pcall(function()
        local head = Character:FindFirstChild("Head")
        if not head then return 0 end
        
        local billboard = head:FindFirstChild("CharacterBillboard")
        if not billboard then return 0 end
        
        local children = billboard:GetChildren()
        if #children < 4 then return 0 end
        
        local textLabel = children[4]
        if not textLabel or not textLabel.ContentText then return 0 end
        
        local text = textLabel.ContentText
        local cleanText = text:gsub("[$,]", "")
        return tonumber(cleanText) or 0
    end)
    
    return success and amount or 0
end

local function checkDropOffEnabled()
    local success, enabled = pcall(function()
        local dropOffPoint = Workspace.Game.Jobs.CriminalDropOffSpawners
            .CriminalDropOffSpawnerPermanent.CriminalDropOffPoint.Zone
            .BillboardAttachment.Billboard
        
        return dropOffPoint.Enabled
    end)
    
    return success and enabled or false
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    DELIVERY SYSTEM                           ║
-- ╚══════════════════════════════════════════════════════════════╝

local function forceDeliverRobbedAmount()
    print("[AutoRob] === Starting Force Delivery ===")
    
    isDeliveryInProgress = true
    
    local dropOffSpawners = Workspace.Game.Jobs.CriminalDropOffSpawners
    if not dropOffSpawners or not dropOffSpawners.CriminalDropOffSpawnerPermanent then
        warn("[AutoRob] Drop-off location not found!")
        isDeliveryInProgress = false
        return false, 0
    end
    
    local robbedAmount = getRobbedAmount()
    print(string.format("[AutoRob] Current robbed amount: %s", formatNumber(robbedAmount)))
    
    if robbedAmount <= 0 then
        print("[AutoRob] No money to deliver")
        isDeliveryInProgress = false
        return false, 0
    end
    
    -- Clean money bags
    for _, bag in pairs(CollectionService:GetTagged("CriminalMoneyBagTool")) do
        pcall(function() bag:Destroy() end)
        task.wait(0.1)
    end
    
    local maxAttempts = 5
    local deliverySuccess = false
    local totalDelivered = 0
    
    for attempt = 1, maxAttempts do
        if not isAutoRobActive then break end
        
        print(string.format("[AutoRob] Delivery attempt %d/%d", attempt, maxAttempts))
        
        local currentAmount = getRobbedAmount()
        if currentAmount == 0 then
            deliverySuccess = true
            print("[AutoRob] ✓ All money delivered!")
            break
        end
        
        -- Teleport to drop-off
        local teleportStart = tick()
        repeat
            task.wait()
            safeTP(dropOffSpawners.CriminalDropOffSpawnerPermanent.CFrame + Vector3.new(0, 5, 0))
        until tick() - teleportStart > 1.5
        
        -- Wait for processing
        local checkStart = tick()
        local lastCheckAmount = currentAmount
        
        repeat
            task.wait(0.3)
            safeTP(dropOffSpawners.CriminalDropOffSpawnerPermanent.CFrame + Vector3.new(0, 5, 0))
            
            currentAmount = getRobbedAmount()
            
            if currentAmount < lastCheckAmount then
                local delivered = lastCheckAmount - currentAmount
                totalDelivered = totalDelivered + delivered
                print(string.format("[AutoRob] ✓ Delivered: %s", formatNumber(delivered)))
                lastCheckAmount = currentAmount
            end
            
            if currentAmount == 0 then
                deliverySuccess = true
                break
            end
        until tick() - checkStart > 5
        
        if deliverySuccess then break end
        task.wait(1)
    end
    
    if deliverySuccess then
        Stats.TotalDelivered = Stats.TotalDelivered + totalDelivered
    end
    
    isDeliveryInProgress = false
    return deliverySuccess, totalDelivered
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    ATM ROBBERY SYSTEM                        ║
-- ╚══════════════════════════════════════════════════════════════╝

local function robSingleATM(atm, atmType)
    if not isAutoRobActive then return false end
    
    local atmTypeName = atmType == "tagged" and "Tagged ATM" or "Nil ATM"
    print(string.format("[AutoRob] Robbing: %s", atmTypeName))
    
    -- Teleport to ATM
    local teleportTime = atmType == "tagged" and 1 or 0.2
    local teleportStart = tick()
    repeat
        task.wait()
        safeTP(atm.WorldPivot + Vector3.new(0, 5, 0))
    until tick() - teleportStart > teleportTime or not isAutoRobActive
    
    if not isAutoRobActive then return false end
    
    local beforeAmount = getRobbedAmount()
    
    -- Start bust
    ReplicatedStorage.Remotes.AttemptATMBustStart:InvokeServer(atm)
    
    -- Wait for progress
    local progressStart = tick()
    repeat
        task.wait()
        safeTP(atm.WorldPivot + Vector3.new(0, 5, 0))
    until tick() - progressStart > 2.5 or not isAutoRobActive
    
    if not isAutoRobActive then return false end
    
    -- Complete bust
    ReplicatedStorage.Remotes.AttemptATMBustComplete:InvokeServer(atm)
    
    -- Wait for cooldown
    local cooldownStart = tick()
    repeat
        task.wait()
        safeTP(atm.WorldPivot + Vector3.new(0, 5, 0))
    until tick() - cooldownStart > 3 or 
          (Character and Character:GetAttribute("ATMBustDebounce")) or 
          not isAutoRobActive
    
    repeat
        task.wait()
        safeTP(atm.WorldPivot + Vector3.new(0, 5, 0))
    until tick() - cooldownStart > 3 or 
          not (Character and Character:GetAttribute("ATMBustDebounce")) or
          not isAutoRobActive
    
    task.wait(0.5)
    
    -- Check success
    local afterAmount = getRobbedAmount()
    local gained = afterAmount - beforeAmount
    
    if gained > 0 then
        Stats.ATMsRobbed = Stats.ATMsRobbed + 1
        Stats.TotalRobbed = Stats.TotalRobbed + gained
        Stats.NoATMCount = 0
        
        print(string.format("[AutoRob] ✓ Gained: +%s", formatNumber(gained)))
        
        -- Check if should deliver
        if _G.AutoRobSettings.AutoDeliver and afterAmount >= _G.AutoRobSettings.TargetAmount then
            if checkDropOffEnabled() then
                print("[AutoRob] Target reached, delivering...")
                local success, delivered = forceDeliverRobbedAmount()
                return true
            end
        end
        
        return false
    else
        print("[AutoRob] ⚠ Robbery failed")
        return false
    end
end

local function findAndRobATMs()
    local foundCount = 0
    local deliveryTriggered = false
    
    -- Rob tagged ATMs
    local taggedATMs = CollectionService:GetTagged("CriminalATM")
    
    for _, atm in pairs(taggedATMs) do
        if not isAutoRobActive then break end
        
        if atm:GetAttribute("State") ~= "Busted" then
            foundCount = foundCount + 1
            deliveryTriggered = robSingleATM(atm, "tagged")
            if deliveryTriggered then break end
        end
    end
    
    -- Rob nil ATMs
    if _G.AutoRobSettings.UseNilATMs and not deliveryTriggered and isAutoRobActive then
        local nilATMs = {}
        for _, obj in pairs(getnilinstances()) do
            if obj.Name == "CriminalATM" and obj:GetAttribute("State") ~= "Busted" then
                table.insert(nilATMs, obj)
            end
        end
        
        for _, atm in pairs(nilATMs) do
            if not isAutoRobActive then break end
            foundCount = foundCount + 1
            deliveryTriggered = robSingleATM(atm, "nil")
            if deliveryTriggered then break end
        end
    end
    
    -- Handle no ATMs
    if foundCount == 0 then
        Stats.NoATMCount = Stats.NoATMCount + 1
        
        if Stats.NoATMCount >= _G.AutoRobSettings.MaxNoATMRetries then
            print("[AutoRob] Searching spawners...")
            
            getfenv().atmloadercooldown = false
            LocalPlayer.ReplicationFocus = nil
            Stats.NoATMCount = 0
            
            local spawnersFolder = Workspace.Game.Jobs.CriminalATMSpawners
            if spawnersFolder then
                local spawners = spawnersFolder:GetChildren()
                
                for i, spawner in ipairs(spawners) do
                    if not isAutoRobActive then break end
                    
                    safeTP(spawner:GetPivot() + Vector3.new(0, 5, 0))
                    task.wait(0.5)
                    LocalPlayer.ReplicationFocus = nil
                    
                    if #CollectionService:GetTagged("CriminalATM") > 0 then
                        Stats.NoATMCount = 0
                        break
                    end
                end
            end
        end
    else
        Stats.NoATMCount = 0
    end
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    WINDUI INTERFACE (PROPER SYNTAX)          ║
-- ╚══════════════════════════════════════════════════════════════╝

print("Loading WindUI...")

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Auto Rob ATM",
    Icon = "dollar-sign",
    Author = "Advanced System",
    Folder = "AutoRobConfig",
    
    Size = UDim2.fromOffset(530, 350),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 150,
})

Window:SetToggleKey(Enum.KeyCode.LeftControl)

WindUI:Notify({
    Title = "Auto Rob ATM",
    Content = "Press Left Control to Toggle Menu",
    Duration = 4,
    Icon = "dollar-sign",
})

-- ═══════════════════ TABS ═══════════════════

local Main = Window:Tab({
    Title = "Auto Rob",
    Icon = "dollar-sign",
    Locked = false,
})

local Settings = Window:Tab({
    Title = "Settings",
    Icon = "settings",
    Locked = false,
})

local Stats_Tab = Window:Tab({
    Title = "Statistics",
    Icon = "bar-chart",
    Locked = false,
})

-- ═══════════════════ MAIN TAB ═══════════════════

local Section1 = Main:Section({
    Title = "Auto Rob Control",
    Opened = true,
})

local AutoRobToggle = Main:Toggle({
    Title = "Enable Auto Rob",
    Type = "Toggle",
    Default = false,
    Callback = function(Value)
        _G.AutoRobSettings.Enabled = Value
        isAutoRobActive = Value
        
        if Value then
            WindUI:Notify({
                Title = "Auto Rob",
                Content = "Auto Rob Started!",
                Duration = 3,
                Icon = "dollar-sign",
            })
            
            spawn(function()
                while isAutoRobActive and _G.AutoRobSettings.Enabled do
                    pcall(findAndRobATMs)
                    task.wait(0.5)
                end
            end)
        else
            WindUI:Notify({
                Title = "Auto Rob",
                Content = "Auto Rob Stopped",
                Duration = 3,
                Icon = "x-circle",
            })
        end
    end
})

Main:Space()

local ForceDeliverButton = Main:Button({
    Title = "Force Deliver Now",
    Locked = false,
    Callback = function()
        local amount = getRobbedAmount()
        if amount > 0 then
            WindUI:Notify({
                Title = "Delivering",
                Content = string.format("Delivering $%s...", formatNumber(amount)),
                Duration = 3,
            })
            
            local success, delivered = forceDeliverRobbedAmount()
            
            if success then
                WindUI:Notify({
                    Title = "Success",
                    Content = string.format("Delivered: $%s", formatNumber(delivered)),
                    Duration = 5,
                })
            else
                WindUI:Notify({
                    Title = "Failed",
                    Content = "Delivery failed!",
                    Duration = 3,
                })
            end
        else
            WindUI:Notify({
                Title = "No Money",
                Content = "You have no money to deliver!",
                Duration = 3,
            })
        end
    end
})

local CheckAmountButton = Main:Button({
    Title = "Check Current Amount",
    Locked = false,
    Callback = function()
        local amount = getRobbedAmount()
        WindUI:Notify({
            Title = "Current Amount",
            Content = string.format("Robbed: $%s", formatNumber(amount)),
            Duration = 4,
        })
    end
})

-- ═══════════════════ SETTINGS TAB ═══════════════════

local Section2 = Settings:Section({
    Title = "Configuration",
    Opened = true,
})

local TargetAmountInput = Settings:Input({
    Title = "Target Amount",
    Placeholder = "Enter amount (e.g., 50000)",
    Callback = function(value)
        local num = tonumber(value)
        if num then
            _G.AutoRobSettings.TargetAmount = num
            WindUI:Notify({
                Title = "Target Updated",
                Content = string.format("New target: $%s", formatNumber(num)),
                Duration = 3,
            })
        end
    end
})

Settings:Space()

local AutoDeliverToggle = Settings:Toggle({
    Title = "Auto Deliver",
    Type = "Toggle",
    Default = true,
    Callback = function(Value)
        _G.AutoRobSettings.AutoDeliver = Value
    end
})

local UseNilATMsToggle = Settings:Toggle({
    Title = "Use Nil ATMs",
    Type = "Toggle",
    Default = true,
    Callback = function(Value)
        _G.AutoRobSettings.UseNilATMs = Value
    end
})

Settings:Space()

local MaxRetriesInput = Settings:Input({
    Title = "Max No-ATM Retries",
    Placeholder = "Default: 5",
    Callback = function(value)
        local num = tonumber(value)
        if num then
            _G.AutoRobSettings.MaxNoATMRetries = num
        end
    end
})

-- ═══════════════════ STATS TAB ═══════════════════

local Section3 = Stats_Tab:Section({
    Title = "Session Statistics",
    Opened = true,
})

local StatsLabel = Stats_Tab:Label({
    Title = "Loading stats...",
    Icon = "bar-chart",
})

-- Update stats
spawn(function()
    while true do
        wait(1)
        
        local currentAmount = getRobbedAmount()
        local sessionTime = (tick() - Stats.SessionStart) / 60
        
        local statsText = string.format(
            "Total Robbed: $%s\nTotal Delivered: $%s\nATMs Robbed: %d\nCurrent Amount: $%s\nSession Time: %.1f min",
            formatNumber(Stats.TotalRobbed),
            formatNumber(Stats.TotalDelivered),
            Stats.ATMsRobbed,
            formatNumber(currentAmount),
            sessionTime
        )
        
        pcall(function()
            StatsLabel:Set(statsText)
        end)
    end
end)

Stats_Tab:Space()

local ResetStatsButton = Stats_Tab:Button({
    Title = "Reset Statistics",
    Locked = false,
    Callback = function()
        Stats.TotalRobbed = 0
        Stats.TotalDelivered = 0
        Stats.ATMsRobbed = 0
        Stats.SessionStart = tick()
        
        WindUI:Notify({
            Title = "Stats Reset",
            Content = "All statistics have been reset",
            Duration = 3,
        })
    end
})

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    STARTUP                                   ║
-- ╚══════════════════════════════════════════════════════════════╝

LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
end)

Main:Select()

print("╔════════════════════════════════════════╗")
print("║   AUTO ROB ATM LOADED SUCCESSFULLY     ║")
print("╠════════════════════════════════════════╣")
print("║ • Auto find & rob ATMs                 ║")
print("║ • Auto delivery system                 ║")
print("║ • Proper WindUI syntax                 ║")
print("║ • Press Left Control to toggle         ║")
print("╚════════════════════════════════════════╝")
