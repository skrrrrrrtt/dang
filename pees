-- ╔══════════════════════════════════════════════════════════════╗
-- ║          ADVANCED PS99 UNIVERSAL SCANNER v2.0                ║
-- ║    Scans EVERYTHING - Workspace, ReplicatedStorage, etc     ║
-- ║         With Error Handling & Crash Prevention               ║
-- ╚══════════════════════════════════════════════════════════════╝

repeat wait() until game:IsLoaded()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local StarterPack = game:GetService("StarterPack")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

-- Scanner Configuration
local ScanConfig = {
    MaxDepth = 50,
    BatchSize = 100,
    YieldInterval = 0.1,
    SaveToFile = true,
    DetailedOutput = true,
    ScanRemotes = true,
    ScanAttributes = true,
    ScanProperties = true,
}

-- Data Storage
local ScanResults = {
    TotalObjects = 0,
    TotalRemotes = 0,
    TotalFunctions = 0,
    TotalValues = 0,
    TotalPets = 0,
    TotalEggs = 0,
    TotalItems = 0,
    TotalChests = 0,
    TotalNPCs = 0,
    Errors = 0,
    StartTime = tick(),
    
    Remotes = {},
    Functions = {},
    Values = {},
    Pets = {},
    Eggs = {},
    Items = {},
    Chests = {},
    NPCs = {},
    Locations = {},
    ModuleScripts = {},
    LocalScripts = {},
    Attributes = {},
}

local ScannedObjects = {}
local CurrentBatch = 0

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    UTILITY FUNCTIONS                         ║
-- ╚══════════════════════════════════════════════════════════════╝

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success then
        ScanResults.Errors = ScanResults.Errors + 1
        return nil, result
    end
    return result
end

local function GetPath(obj)
    return SafeCall(function()
        return obj:GetFullName()
    end) or "Unknown Path"
end

local function GetClassName(obj)
    return SafeCall(function()
        return obj.ClassName
    end) or "Unknown"
end

local function GetObjectName(obj)
    return SafeCall(function()
        return obj.Name
    end) or "Unknown"
end

local function GetPosition(obj)
    return SafeCall(function()
        if obj:IsA("BasePart") then
            return obj.Position
        elseif obj:IsA("Model") then
            local primaryPart = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
            if primaryPart then
                return primaryPart.Position
            end
        end
        return nil
    end)
end

local function GetCFrame(obj)
    return SafeCall(function()
        if obj:IsA("BasePart") then
            return obj.CFrame
        elseif obj:IsA("Model") then
            local primaryPart = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
            if primaryPart then
                return primaryPart.CFrame
            end
        end
        return nil
    end)
end

local function FormatNumber(num)
    if num >= 1000000 then
        return string.format("%.2fM", num / 1000000)
    elseif num >= 1000 then
        return string.format("%.2fK", num / 1000)
    end
    return tostring(num)
end

local function GetDistance(position)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return (LocalPlayer.Character.HumanoidRootPart.Position - position).Magnitude
    end
    return 0
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    SCANNING FUNCTIONS                        ║
-- ╚══════════════════════════════════════════════════════════════╝

local function ScanAttributes(obj)
    SafeCall(function()
        local attributes = obj:GetAttributes()
        if attributes and next(attributes) then
            for attrName, attrValue in pairs(attributes) do
                table.insert(ScanResults.Attributes, {
                    Object = GetObjectName(obj),
                    Path = GetPath(obj),
                    AttributeName = attrName,
                    AttributeValue = tostring(attrValue),
                    ValueType = type(attrValue)
                })
            end
        end
    end)
end

local function ScanRemote(obj)
    if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") or obj:IsA("BindableEvent") or obj:IsA("BindableFunction") then
        ScanResults.TotalRemotes = ScanResults.TotalRemotes + 1
        
        table.insert(ScanResults.Remotes, {
            Name = GetObjectName(obj),
            Type = GetClassName(obj),
            Path = GetPath(obj),
            Parent = obj.Parent and GetObjectName(obj.Parent) or "None"
        })
    end
end

local function ScanFunction(obj)
    if obj:IsA("ModuleScript") then
        ScanResults.TotalFunctions = ScanResults.TotalFunctions + 1
        
        table.insert(ScanResults.ModuleScripts, {
            Name = GetObjectName(obj),
            Path = GetPath(obj),
            Parent = obj.Parent and GetObjectName(obj.Parent) or "None"
        })
    elseif obj:IsA("LocalScript") then
        table.insert(ScanResults.LocalScripts, {
            Name = GetObjectName(obj),
            Path = GetPath(obj),
            Parent = obj.Parent and GetObjectName(obj.Parent) or "None"
        })
    end
end

local function ScanValue(obj)
    if obj:IsA("ValueBase") then
        ScanResults.TotalValues = ScanResults.TotalValues + 1
        
        local value = SafeCall(function()
            return tostring(obj.Value)
        end) or "N/A"
        
        table.insert(ScanResults.Values, {
            Name = GetObjectName(obj),
            Type = GetClassName(obj),
            Value = value,
            Path = GetPath(obj)
        })
    end
end

local function ScanPet(obj)
    local name = GetObjectName(obj):lower()
    local path = GetPath(obj):lower()
    
    -- PS99 Pet detection
    if name:find("pet") or path:find("pet") or 
       obj:FindFirstChild("PetType") or obj:FindFirstChild("Rarity") or
       obj:FindFirstChild("Level") or obj:FindFirstChild("Attack") then
        
        ScanResults.TotalPets = ScanResults.TotalPets + 1
        
        local petData = {
            Name = GetObjectName(obj),
            Path = GetPath(obj),
            Type = GetClassName(obj),
            Position = GetPosition(obj),
            Attributes = {}
        }
        
        -- Scan for pet-specific attributes
        SafeCall(function()
            local attrs = obj:GetAttributes()
            if attrs then
                for k, v in pairs(attrs) do
                    petData.Attributes[k] = v
                end
            end
        end)
        
        -- Check for common pet properties
        for _, propName in pairs({"Rarity", "Level", "Attack", "PetType", "Multiplier", "Equipped"}) do
            local prop = obj:FindFirstChild(propName)
            if prop then
                petData[propName] = SafeCall(function()
                    return tostring(prop.Value or prop)
                end) or "Unknown"
            end
        end
        
        table.insert(ScanResults.Pets, petData)
    end
end

local function ScanEgg(obj)
    local name = GetObjectName(obj):lower()
    local path = GetPath(obj):lower()
    
    -- PS99 Egg detection
    if name:find("egg") or path:find("egg") or name:find("hatch") then
        ScanResults.TotalEggs = ScanResults.TotalEggs + 1
        
        local position = GetPosition(obj)
        local eggData = {
            Name = GetObjectName(obj),
            Path = GetPath(obj),
            Type = GetClassName(obj),
            Position = position,
            Distance = position and GetDistance(position) or 0,
            CFrame = GetCFrame(obj)
        }
        
        table.insert(ScanResults.Eggs, eggData)
    end
end

local function ScanItem(obj)
    local name = GetObjectName(obj):lower()
    
    -- PS99 Item detection
    if name:find("coin") or name:find("chest") or name:find("lootbag") or 
       name:find("diamond") or name:find("gift") or name:find("present") then
        
        ScanResults.TotalItems = ScanResults.TotalItems + 1
        
        local position = GetPosition(obj)
        table.insert(ScanResults.Items, {
            Name = GetObjectName(obj),
            Path = GetPath(obj),
            Position = position,
            Distance = position and GetDistance(position) or 0
        })
    end
end

local function ScanChest(obj)
    local name = GetObjectName(obj):lower()
    
    if name:find("chest") or name:find("crate") or name:find("vault") then
        ScanResults.TotalChests = ScanResults.TotalChests + 1
        
        local position = GetPosition(obj)
        table.insert(ScanResults.Chests, {
            Name = GetObjectName(obj),
            Path = GetPath(obj),
            Position = position,
            Distance = position and GetDistance(position) or 0,
            CFrame = GetCFrame(obj)
        })
    end
end

local function ScanNPC(obj)
    local name = GetObjectName(obj):lower()
    
    -- NPC detection
    if obj:IsA("Model") and (obj:FindFirstChild("Humanoid") or name:find("npc") or name:find("merchant") or name:find("seller")) then
        ScanResults.TotalNPCs = ScanResults.TotalNPCs + 1
        
        local position = GetPosition(obj)
        table.insert(ScanResults.NPCs, {
            Name = GetObjectName(obj),
            Path = GetPath(obj),
            Position = position,
            Distance = position and GetDistance(position) or 0
        })
    end
end

local function ScanLocation(obj)
    if obj:IsA("BasePart") or obj:IsA("Model") then
        local name = GetObjectName(obj):lower()
        
        -- Location/Area detection
        if name:find("zone") or name:find("area") or name:find("world") or 
           name:find("island") or name:find("spawn") or name:find("teleport") then
            
            local position = GetPosition(obj)
            table.insert(ScanResults.Locations, {
                Name = GetObjectName(obj),
                Path = GetPath(obj),
                Position = position,
                CFrame = GetCFrame(obj)
            })
        end
    end
end

-- Main scanning function for a single object
local function ScanObject(obj, depth)
    if not obj or ScannedObjects[obj] or depth > ScanConfig.MaxDepth then
        return
    end
    
    -- Mark as scanned
    ScannedObjects[obj] = true
    ScanResults.TotalObjects = ScanResults.TotalObjects + 1
    
    -- Yield periodically to prevent crash
    CurrentBatch = CurrentBatch + 1
    if CurrentBatch >= ScanConfig.BatchSize then
        CurrentBatch = 0
        wait(ScanConfig.YieldInterval)
    end
    
    -- Run all scan types with error protection
    SafeCall(ScanRemote, obj)
    SafeCall(ScanFunction, obj)
    SafeCall(ScanValue, obj)
    SafeCall(ScanPet, obj)
    SafeCall(ScanEgg, obj)
    SafeCall(ScanItem, obj)
    SafeCall(ScanChest, obj)
    SafeCall(ScanNPC, obj)
    SafeCall(ScanLocation, obj)
    
    if ScanConfig.ScanAttributes then
        SafeCall(ScanAttributes, obj)
    end
end

-- Recursive scan with depth limit
local function ScanContainer(container, depth)
    depth = depth or 1
    
    if depth > ScanConfig.MaxDepth then
        return
    end
    
    SafeCall(function()
        for _, obj in pairs(container:GetChildren()) do
            ScanObject(obj, depth)
            ScanContainer(obj, depth + 1)
        end
    end)
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    PROGRESS DISPLAY                          ║
-- ╚══════════════════════════════════════════════════════════════╝

local function PrintProgress(message, category)
    local elapsed = tick() - ScanResults.StartTime
    local prefix = string.format("[%.1fs]", elapsed)
    
    if category then
        print(prefix .. " [" .. category .. "] " .. message)
    else
        print(prefix .. " " .. message)
    end
end

local function PrintHeader(text)
    local line = string.rep("═", 60)
    print("\n╔" .. line .. "╗")
    print("║ " .. text .. string.rep(" ", 59 - #text) .. "║")
    print("╚" .. line .. "╝")
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    MAIN SCANNING PROCESS                     ║
-- ╚══════════════════════════════════════════════════════════════╝

PrintHeader("PS99 ADVANCED SCANNER - STARTING")

-- Scan Workspace
PrintProgress("Scanning Workspace...", "WORKSPACE")
ScanContainer(Workspace)
PrintProgress(string.format("✓ Workspace: %s objects", FormatNumber(ScanResults.TotalObjects)), "WORKSPACE")

-- Scan ReplicatedStorage
PrintProgress("Scanning ReplicatedStorage...", "REPLICATED")
ScanContainer(ReplicatedStorage)
PrintProgress(string.format("✓ ReplicatedStorage: %s remotes", FormatNumber(ScanResults.TotalRemotes)), "REPLICATED")

-- Scan Lighting
PrintProgress("Scanning Lighting...", "LIGHTING")
ScanContainer(Lighting)

-- Scan StarterGui
PrintProgress("Scanning StarterGui...", "STARTERGUI")
ScanContainer(StarterGui)

-- Scan StarterPack
PrintProgress("Scanning StarterPack...", "STARTERPACK")
ScanContainer(StarterPack)

-- Scan Players
PrintProgress("Scanning Players...", "PLAYERS")
for _, player in pairs(Players:GetPlayers()) do
    SafeCall(function()
        if player.Character then
            ScanContainer(player.Character)
        end
        ScanContainer(player:WaitForChild("PlayerGui", 1))
        ScanContainer(player:WaitForChild("Backpack", 1))
    end)
end

-- Scan LocalPlayer specific
PrintProgress("Scanning LocalPlayer data...", "LOCALPLAYER")
SafeCall(function()
    if LocalPlayer:FindFirstChild("PlayerGui") then
        ScanContainer(LocalPlayer.PlayerGui)
    end
    if LocalPlayer:FindFirstChild("Backpack") then
        ScanContainer(LocalPlayer.Backpack)
    end
end)

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    RESULTS COMPILATION                       ║
-- ╚══════════════════════════════════════════════════════════════╝

local function CompileResults()
    local output = {}
    
    -- Header
    table.insert(output, "╔" .. string.rep("═", 78) .. "╗")
    table.insert(output, "║" .. string.rep(" ", 20) .. "PS99 ADVANCED SCAN RESULTS" .. string.rep(" ", 32) .. "║")
    table.insert(output, "╠" .. string.rep("═", 78) .. "╣")
    table.insert(output, string.format("║ Scan Date: %-65s ║", os.date()))
    table.insert(output, string.format("║ Scan Duration: %.2f seconds" .. string.rep(" ", 49) .. "║", tick() - ScanResults.StartTime))
    table.insert(output, string.format("║ Total Objects Scanned: %-55s ║", FormatNumber(ScanResults.TotalObjects)))
    table.insert(output, string.format("║ Errors Handled: %-61s ║", ScanResults.Errors))
    table.insert(output, "╚" .. string.rep("═", 78) .. "╝")
    table.insert(output, "")
    
    -- Summary Statistics
    table.insert(output, "\n═══════════════════════ SUMMARY STATISTICS ════════════════════════")
    table.insert(output, string.format("  Total Remotes Found:      %d", ScanResults.TotalRemotes))
    table.insert(output, string.format("  Total ModuleScripts:      %d", #ScanResults.ModuleScripts))
    table.insert(output, string.format("  Total LocalScripts:       %d", #ScanResults.LocalScripts))
    table.insert(output, string.format("  Total Values:             %d", ScanResults.TotalValues))
    table.insert(output, string.format("  Total Pets Detected:      %d", ScanResults.TotalPets))
    table.insert(output, string.format("  Total Eggs Found:         %d", ScanResults.TotalEggs))
    table.insert(output, string.format("  Total Items:              %d", ScanResults.TotalItems))
    table.insert(output, string.format("  Total Chests:             %d", ScanResults.TotalChests))
    table.insert(output, string.format("  Total NPCs:               %d", ScanResults.TotalNPCs))
    table.insert(output, string.format("  Total Locations:          %d", #ScanResults.Locations))
    table.insert(output, string.format("  Total Attributes:         %d", #ScanResults.Attributes))
    table.insert(output, "═══════════════════════════════════════════════════════════════════\n")
    
    -- Remotes
    if #ScanResults.Remotes > 0 then
        table.insert(output, "\n" .. string.rep("═", 70))
        table.insert(output, "REMOTE EVENTS & FUNCTIONS (" .. #ScanResults.Remotes .. " total)")
        table.insert(output, string.rep("═", 70))
        
        for i, remote in ipairs(ScanResults.Remotes) do
            table.insert(output, string.format("\n[%d] %s", i, remote.Name))
            table.insert(output, string.format("    Type: %s", remote.Type))
            table.insert(output, string.format("    Path: %s", remote.Path))
            table.insert(output, string.format("    Parent: %s", remote.Parent))
        end
    end
    
    -- Pets
    if #ScanResults.Pets > 0 then
        table.insert(output, "\n\n" .. string.rep("═", 70))
        table.insert(output, "PETS DETECTED (" .. #ScanResults.Pets .. " total)")
        table.insert(output, string.rep("═", 70))
        
        for i, pet in ipairs(ScanResults.Pets) do
            table.insert(output, string.format("\n[%d] %s", i, pet.Name))
            table.insert(output, string.format("    Path: %s", pet.Path))
            if pet.Rarity then
                table.insert(output, string.format("    Rarity: %s", pet.Rarity))
            end
            if pet.Level then
                table.insert(output, string.format("    Level: %s", pet.Level))
            end
            if next(pet.Attributes) then
                table.insert(output, "    Attributes:")
                for k, v in pairs(pet.Attributes) do
                    table.insert(output, string.format("      - %s: %s", k, tostring(v)))
                end
            end
        end
    end
    
    -- Eggs
    if #ScanResults.Eggs > 0 then
        table.insert(output, "\n\n" .. string.rep("═", 70))
        table.insert(output, "EGGS & HATCHING LOCATIONS (" .. #ScanResults.Eggs .. " total)")
        table.insert(output, string.rep("═", 70))
        
        -- Sort by distance
        table.sort(ScanResults.Eggs, function(a, b)
            return (a.Distance or 999999) < (b.Distance or 999999)
        end)
        
        for i, egg in ipairs(ScanResults.Eggs) do
            table.insert(output, string.format("\n[%d] %s", i, egg.Name))
            table.insert(output, string.format("    Path: %s", egg.Path))
            if egg.Position then
                table.insert(output, string.format("    Position: %.1f, %.1f, %.1f", 
                    egg.Position.X, egg.Position.Y, egg.Position.Z))
            end
            if egg.Distance then
                table.insert(output, string.format("    Distance: %.0f studs", egg.Distance))
            end
            if egg.CFrame then
                local pos = egg.CFrame.Position
                table.insert(output, string.format("    CFrame: CFrame.new(%.2f, %.2f, %.2f)", 
                    pos.X, pos.Y, pos.Z))
            end
        end
    end
    
    -- Chests
    if #ScanResults.Chests > 0 then
        table.insert(output, "\n\n" .. string.rep("═", 70))
        table.insert(output, "CHESTS & LOOT CONTAINERS (" .. #ScanResults.Chests .. " total)")
        table.insert(output, string.rep("═", 70))
        
        table.sort(ScanResults.Chests, function(a, b)
            return (a.Distance or 999999) < (b.Distance or 999999)
        end)
        
        for i, chest in ipairs(ScanResults.Chests) do
            table.insert(output, string.format("\n[%d] %s (%.0f studs)", i, chest.Name, chest.Distance or 0))
            table.insert(output, string.format("    Path: %s", chest.Path))
            if chest.Position then
                table.insert(output, string.format("    Position: %.1f, %.1f, %.1f", 
                    chest.Position.X, chest.Position.Y, chest.Position.Z))
            end
        end
    end
    
    -- NPCs
    if #ScanResults.NPCs > 0 then
        table.insert(output, "\n\n" .. string.rep("═", 70))
        table.insert(output, "NPCs & MERCHANTS (" .. #ScanResults.NPCs .. " total)")
        table.insert(output, string.rep("═", 70))
        
        for i, npc in ipairs(ScanResults.NPCs) do
            table.insert(output, string.format("\n[%d] %s", i, npc.Name))
            table.insert(output, string.format("    Path: %s", npc.Path))
            if npc.Distance then
                table.insert(output, string.format("    Distance: %.0f studs", npc.Distance))
            end
        end
    end
    
    -- Locations
    if #ScanResults.Locations > 0 then
        table.insert(output, "\n\n" .. string.rep("═", 70))
        table.insert(output, "ZONES & LOCATIONS (" .. #ScanResults.Locations .. " total)")
        table.insert(output, string.rep("═", 70))
        
        for i, loc in ipairs(ScanResults.Locations) do
            table.insert(output, string.format("\n[%d] %s", i, loc.Name))
            table.insert(output, string.format("    Path: %s", loc.Path))
            if loc.CFrame then
                local pos = loc.CFrame.Position
                table.insert(output, string.format("    CFrame: CFrame.new(%.2f, %.2f, %.2f)", 
                    pos.X, pos.Y, pos.Z))
            end
        end
    end
    
    -- Module Scripts
    if #ScanResults.ModuleScripts > 0 then
        table.insert(output, "\n\n" .. string.rep("═", 70))
        table.insert(output, "MODULE SCRIPTS (" .. #ScanResults.ModuleScripts .. " total)")
        table.insert(output, string.rep("═", 70))
        
        for i, mod in ipairs(ScanResults.ModuleScripts) do
            table.insert(output, string.format("[%d] %s - %s", i, mod.Name, mod.Path))
        end
    end
    
    -- Attributes (limit to first 100)
    if #ScanResults.Attributes > 0 then
        table.insert(output, "\n\n" .. string.rep("═", 70))
        table.insert(output, "OBJECT ATTRIBUTES (showing first 100 of " .. #ScanResults.Attributes .. ")")
        table.insert(output, string.rep("═", 70))
        
        for i = 1, math.min(100, #ScanResults.Attributes) do
            local attr = ScanResults.Attributes[i]
            table.insert(output, string.format("\n[%d] %s.%s", i, attr.Object, attr.AttributeName))
            table.insert(output, string.format("    Value: %s (%s)", attr.AttributeValue, attr.ValueType))
            table.insert(output, string.format("    Path: %s", attr.Path))
        end
        
        if #ScanResults.Attributes > 100 then
            table.insert(output, string.format("\n... and %d more attributes", #ScanResults.Attributes - 100))
        end
    end
    
    return table.concat(output, "\n")
end

-- ╔══════════════════════════════════════════════════════════════╗
-- ║                    SAVE RESULTS                              ║
-- ╚══════════════════════════════════════════════════════════════╝

local compiledResults = CompileResults()

-- Print to console
print("\n" .. compiledResults)

-- Save to file
if ScanConfig.SaveToFile then
    local filename = "PS99_Scan_" .. os.time() .. ".txt"
    SafeCall(function()
        writefile(filename, compiledResults)
        PrintProgress("✓ Results saved to: " .. filename, "SAVE")
    end)
    
    -- Also save JSON format
    local jsonFilename = "PS99_Scan_" .. os.time() .. ".json"
    SafeCall(function()
        local jsonData = HttpService:JSONEncode({
            ScanDate = os.date(),
            Duration = tick() - ScanResults.StartTime,
            Statistics = {
                TotalObjects = ScanResults.TotalObjects,
                TotalRemotes = ScanResults.TotalRemotes,
                TotalPets = ScanResults.TotalPets,
                TotalEggs = ScanResults.TotalEggs,
                TotalChests = ScanResults.TotalChests,
                Errors = ScanResults.Errors
            },
            Remotes = ScanResults.Remotes,
            Pets = ScanResults.Pets,
            Eggs = ScanResults.Eggs,
            Chests = ScanResults.Chests,
            NPCs = ScanResults.NPCs,
            Locations = ScanResults.Locations,
            ModuleScripts = ScanResults.ModuleScripts
        })
        writefile(jsonFilename, jsonData)
        PrintProgress("✓ JSON data saved to: " .. jsonFilename, "SAVE")
    end)
end

-- Final summary
PrintHeader("SCAN COMPLETE")
print(string.format("✓ Scanned %s objects in %.2f seconds", 
    FormatNumber(ScanResults.TotalObjects), 
    tick() - ScanResults.StartTime))
print(string.format("✓ Found %d remotes, %d pets, %d eggs, %d chests", 
    ScanResults.TotalRemotes,
    ScanResults.TotalPets,
    ScanResults.TotalEggs,
    ScanResults.TotalChests))
print(string.format("✓ Errors handled: %d", ScanResults.Errors))

-- Store results globally
_G.PS99ScanResults = ScanResults
print("\n✓ Results stored in _G.PS99ScanResults")
